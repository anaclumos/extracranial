---
title: '2022-07-11'
date: '2022-07-11'
slug: '/2022-07-11'
---

## [[Brane]] Notes
### 오늘 할 일
- 송수신부 로직을 정확하게 파악하고 어떻게 [[SharedArrayBuffer]]로 바꿀 것인지 계획한다.
- Tim에게 미팅 시간까지 완성하여 보고한다. 
- 근데 굳이 [[SharedArrayBuffer]]로 바꿔야하는 이유는 뭐지?
	- 지금 확인해보니까 모든 구현이 `worker.postMessage`로 돼있다. 이거 IO가 제한이 걸릴 것이다.
	- SharedArrayBuffer를 쓰는 이유가 You can pass around comparably longer data with SharedArrayBuffer between agents (i.e., main thread and worker.) 임을 기억하자.

결론적으로 [[Brane]], 또는 [[DOM]]을 만든다는 것에 내가 이해한 바는 다음과 같다.
- 엄청나게 커다란 [[JS]] 오브젝트를 만든다.
- 여기에 온갖 DOM-like한 인터페이스들이 웹표준에 맞게 구현되어 있다.
- [[Worker]]에 스크립트를 넣고, `document = brane` 하여 worker가 brane 객체에 접근하게 한다.
- [[Brane]]에는 온갖 이벤트 리스너들이 달려있다. Worker에 있던 스크립트가 무언가 변환을 했을 때, 이를 보고 승인 가능한 변환이면 그를 변환한다.
- 그 변환된 것을 우리가 눈에 보이는 [[DOM]]에도 그린다.

그러니까, 우리는 ATM을 만드는거다.

![[Pasted image 20220711010013.png]]

### 진척도
- `install`되는 부분부터 역추적해보기 위해 `console.log`를 설치했다.
	- 아무래도 build될 때 `console.log` 등은 자동으로 삭제하는 것 같다. 
	- `debug/main.js`에서 `console.log` 를 발견했다.

![[Pasted image 20220711013828.png]]

[[2022-07-06]]에 만든 데모 스크립트에서 위와 같이 동작하는 것을 확인했다.
이 `console.log`는 여기에 있다.

![[Pasted image 20220711014245.png]]

- 보니까 `postMessage`를 `postThroughSab` 같은 메소드로 전부 대체하면 되겠다.

그렇다면 계획:
- `postThroughSab` (마치 hook처럼 쓸 수 있게) 을 만든다.
- `postThroughSab`의 모든 인터페이스는 `postMessage`를 따른다.
	- 내부 구현체만 [[SharedArrayBuffer]]로 되어있는 것이다.
- onMessage는 사용 빈도가 훨씬 적은데 (왜지?) 이것도 비슷한 방식으로 폴리필한다.
- 정상 동작해야한다.
- 이렇게하면 Throughput이 훨씬 높은 WorkerDOM 모델을 만들 수 있을 것으로 기대한다.